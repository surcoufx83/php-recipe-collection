
      var running = false;
      var spinner = null;
      var button = null;

      $('#activation-form').submit(function(event) {
        event.preventDefault();
        var frm = $(this);
        if (running)
          return;
        if (checkPasswordFields() == false) {
          return;
        }
        running = true;
        initlogin();

        $.ajax({
          method: 'POST',
          url: frm.attr('action'),
          data: {
            'keepSession': $('#activation-keepsession').prop('checked'),
            'password1': $('#password').val(),
            'password2': $('#password2').val(),
            'user': $('#activation-user').val()
          }
        }).done(function(data) {
          if (data.isLoggedIn) {
            successlogin();
            location.replace('/');
          } else {
            easytooltip($('#login-submit-button'), '{{ Controller.l("page_login_failed_loginFailed") }}', 'error');
          }
          finishlogin();
        }).fail(function(obj, error, errno) {
          easytooltip($('#login-submit-button'), '{{ Controller.l("page_login_failed_loginFailed") }}', 'error');
          finishlogin();
        });

      });

      function initlogin() {
        button = $('#activation-submit');
        spinner = $('#activation-spinner');
        button.prop('disabled', true);
        spinner.removeClass('d-none');
      }

      function finishlogin() {
        button.prop('disabled', false);
        spinner.addClass('d-none');
        running = false;
      }

      function successlogin() {
        button.removeClass('btn-blue');
        button.addClass('btn-success');
        spinner.addClass('d-none');
      }

      function checkPasswordFields() {
        var obj1 = $('#password');
        var obj2 = $('#password2');
        var empty = false;
        if (obj1.val() == '') {
          empty = true;
          obj1[0].setCustomValidity('false');
        }
        if (obj2.val() == '') {
          empty = true;
          obj2[0].setCustomValidity('false');
        }
        if (empty)
          return false;
        if (obj1.val() != obj2.val()) {
          obj2[0].setCustomValidity('false');
          return false;
        }
        obj2[0].setCustomValidity('');
        return true;
      }
